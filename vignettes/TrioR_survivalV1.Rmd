---
title: "TrioR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TrioR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
--- 

```{r setup, message=FALSE}
devtools::load_all()
library(BenchHub)
library(limma)
library(dplyr)
```

# TrioB1

Calculate the accuracy of survival model prediction

- Here, we use the survival data from survBenchmark-figShare. 
- This survival data is clinical (lung). 
- The Figshare ID is [figshare:26142922/47361046](https://figshare.com/articles/dataset/SurvBenchmark_comprehensive_benchmarking_study_of_survival_analysis_methods_using_both_omics_data_and_clinical_data/26142922?file=47361079) 

```{r, message=FALSE}
testCache <- tempdir()
trioB1 <- Trio$new("figshare:26142922/47361046", cachePath = testCache)
data <- trioB1 |> purrr::pluck("data")
```

# Preprocessing: Feature selection of ONLY omics data 

```{r}
data_filtered <- data[, !grepl("\\.\\.\\.1|time", colnames(data))]
data_filtered$status <- factor(data_filtered$status, levels = c(0, 1))
design <- model.matrix(~ 0 + data_filtered$status)
colnames(design) <- c("Group0", "Group1")

expression_data <- t(data_filtered[, sapply(data_filtered, is.numeric) & colnames(data_filtered) != "status"])

fit <- lmFit(expression_data, design)
contrast_matrix <- makeContrasts(Group1 - Group0, levels = design)
fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2)

top_genes <- topTable(fit2, number = 100, adjust = "BH", sort.by = "P")

top_gene_names <- rownames(top_genes)
data_new <- data[, c(top_gene_names, "time", "status")]

trioB1$data <- data_new
```


Prepare survival model 

In this example, we use Cox proportional hazards regression model. 
Since we use c-index as evaluation metric, we here usethe Cross-validation folds for an example. 

Preapre function

- surv_risk_pred: risk prediction/expectation
- surv_obj: survival object, this is for Gold Standard

```{r}
surv_risk_pred <- function(model, data) {
  if (is.null(data)) {
    return(unname(stats::predict(model, type = "risk")))
  } else {
    return(unname(stats::predict(model, newdata = data, type = "risk")))
  }
}

surv_risk_pred_rsf <- function(model, data) {
  if (is.null(data)) {
    return(model$predicted)
  } else {
    return(predict(model, newdata = data)$predicted)
  }
}


surv_obj <- function(data) {
  sub_data_test <- data[data[,"index"] == "test", ]
  sub_data_train <- data[data[,"index"] == "train", ]
  test_surv_obj <- with(sub_data_test, survival::Surv(time, status))
  train_surv_obj <- with(sub_data_train, survival::Surv(time, status))
  return(list(train_surv_obj, test_surv_obj))
}

harrelCIndexMetric <- function(to_eval, gs) {
  harrelC1 <- Hmisc::rcorr.cens(-to_eval[[2]], gs[[2]])
  return(harrelC1["C Index"])
}

brierScoreMetric <- function(to_eval, gs) {
  time <- gs[[1]][,"time"]
  brier_score <- survAUC::predErr(gs[[1]], gs[[2]],to_eval[[1]], to_eval[[2]],times=time, type = "brier", int.type = "unweighted")$error
  return(mean(brier_score))
}


timeDependentAUCMetric <- function(to_eval, gs) {
  time <- gs[[1]][,"time"]
  AUC_CD <- survAUC::AUC.uno(gs[[1]], gs[[2]], to_eval[[2]], time)
  return(mean(AUC_CD$auc))
}
```


Add the metric and AuxData into the trioB1

```{r}
trioB1$addMetric("Harrel C-Index", harrelCIndexMetric)
trioB1$addMetric("Brier Score", brierScoreMetric)
trioB1$addMetric("AUC", timeDependentAUCMetric)

trioB1$addAuxData("surv_obj", surv_obj, c("Harrel C-Index", "Brier Score", "AUC"))

set.seed(1234)

trioB1$split(y = data$status, n_fold = 5, n_repeat = 10)
cv_ind <- trioB1$splitIndices
cv_res_harrelCIndex = cv_res_brierScore = cv_res_timeDependentAUC = c()
```

```{r, warning=FALSE}
# Model 1: cox model
for (i in 1:length(cv_ind)) {
  
  data <- trioB1 |> purrr::pluck("data")
  
  train_id = cv_ind[[i]]
  test_id <- setdiff(seq_len(nrow(data)), train_id)
  
  train = data[train_id, ]
  test = data[-train_id, ]
  # Model 1: cox model
  fit_cox <- survival::coxph(survival::Surv(time, status) ~ ., data = train)
  # Model 2: 
  # fit_rsf <- randomForestSRC::rfsrc(survival::Surv(time, status) ~ ., data = train)
  
  data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")
  
  predicted_cox <- list(
        ifelse(is.infinite(surv_risk_pred(fit, NULL)), 0, surv_risk_pred(fit, NULL)),
        ifelse(is.infinite(surv_risk_pred(fit, test)), 0, surv_risk_pred(fit, test))
      )
  
  # predicted_rsf <- list(
  #       ifelse(is.infinite(surv_risk_pred_rsf(fit, NULL)), 0, surv_risk_pred_rsf(fit, NULL)),
  #       ifelse(is.infinite(surv_risk_pred_rsf(fit, test)), 0, surv_risk_pred_rsf(fit, test))
  #     )
  
  trioB1$data <- data
  
  evaluation <- trioB1$evaluate(list(surv_obj = predicted))
  
  
  # evaluation <- trioB1$evaluate(
  #   list(
  #     cox = list(
  #       surv_obj = predicted_cox
  #       ),
  #     rsf = list(
  #       surv_obj = predicted_rsf
  #     ),
  #     separateMethods = TRUE
  #     )
  # )
  
  trioB1$data <- data[ , -which(names(data) %in% c("index"))]
  
  cv_res_harrelCIndex[i] = evaluation$surv_obj$`Harrel C-Index`
  cv_res_brierScore[i] = evaluation$surv_obj$`Brier Score`
  cv_res_timeDependentAUC[i] = evaluation$surv_obj$AUC
  
  # evaluation$time 
  # put time/memory into the meta field
  
}

```

```{r, warning=FALSE}
# Model 2: random forest model
for (i in 1:length(cv_ind)) {

  data <- trioB1 |> purrr::pluck("data")
  
  train_id = cv_ind[[i]]
  test_id <- setdiff(seq_len(nrow(data)), train_id)
  
  train = data[train_id, ]
  test = data[-train_id, ]

  # Model 2: random forest model
  fit <- randomForestSRC::rfsrc(survival::Surv(time, status) ~ ., data = train)
  
  data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")
  
  predicted <- list(
        ifelse(is.infinite(surv_risk_pred_rsf(fit, NULL)), 0, surv_risk_pred_rsf(fit, NULL)),
        ifelse(is.infinite(surv_risk_pred_rsf(fit, test)), 0, surv_risk_pred_rsf(fit, test))
      )
  
  trioB1$data <- data
        
  evaluation <- trioB1$evaluate(list(surv_obj = predicted))
  
  trioB1$data <- data[ , -which(names(data) %in% c("index"))]
  
  cv_res_harrelCIndex[i] = evaluation$surv_obj$`Harrel C-Index`
  cv_res_brierScore[i] = evaluation$surv_obj$`Brier Score`
  cv_res_timeDependentAUC[i] = evaluation$surv_obj$AUC
  
}

```

# Model 3: Multitask logistic regression method

```{r, warning=FALSE}
for (i in 1:length(cv_ind)) {
 
  data <- trioB1 |> purrr::pluck("data")
  
  # Define training and testing sets
  train_id <- cv_ind[[i]]
  test_id <- setdiff(seq_len(nrow(data)), train_id)

  train <- data[train_id, ]
  test <- data[-train_id, ]

  se <- MTLR::mtlr_cv(survival::Surv(time, status) ~ . , train, C1_vec = c(0.01, 0.05, 0.1, 0.5, 1, 10))
  
  fullMod <- MTLR::mtlr(survival::Surv(time, status) ~ . , data = train, C1 = se$best_C1)
  
  # Assign "test" and "train" labels
  data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")

# Get predictions
predicted <- list(
  predict(fullMod, train, type = "prob_event"),
  predict(fullMod, test, type = "prob_event")
)
  
  trioB1$data <- data
  
  evaluation <- trioB1$evaluate(list(surv_obj = predicted))
  
  trioB1$data <- data[ , -which(names(data) %in% c("index"))]
  
  cv_res_harrelCIndex[i] = evaluation$surv_obj$`Harrel C-Index`
  cv_res_brierScore[i] = evaluation$surv_obj$`Brier Score`
  cv_res_timeDependentAUC[i] = evaluation$surv_obj$AUC
  
}

```

# Model 4: Survival support vector machine

```{r, warning=FALSE}
for (i in 1:length(cv_ind)) {
  
  data <- trioB1 |> purrr::pluck("data")

  train_id <- cv_ind[[i]]
  test_id <- setdiff(seq_len(nrow(data)), train_id)

  train <- data[train_id, ]
  test <- data[-train_id, ]

  fullMod <- survivalsvm::survivalsvm(
    formula = survival::Surv(time, status) ~ .,
    data = train,
    gamma.mu = 0.1,       
    kernel = "lin_kernel" 
)

  data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")

  predicted <- list(
    as.vector(predict(fullMod, train)$predicted),
    as.vector(predict(fullMod, test)$predicted)
  )
  
  trioB1$data <- data
  
  evaluation <- trioB1$evaluate(list(surv_obj = predicted))
  
  trioB1$data <- data[ , -which(names(data) %in% c("index"))]
  
  cv_res_harrelCIndex[i] = evaluation$surv_obj$`Harrel C-Index`
  cv_res_brierScore[i] = evaluation$surv_obj$`Brier Score`
  cv_res_timeDependentAUC[i] = evaluation$surv_obj$AUC
  
}

```

# Model 5: cox boost model

```{r, warning=FALSE}
for (i in 1:length(cv_ind)) {
  
  data <- trioB1 |> purrr::pluck("data")

  train_id <- cv_ind[[i]]
  test_id <- setdiff(seq_len(nrow(data)), train_id)

  train <- data[train_id, ]
  test <- data[-train_id, ]

  tr_predictormatrix=train[,-which(colnames(train)%in% c("time","status"))]
  tr_predictormatrix=data.matrix(tr_predictormatrix)
  te_predictormatrix=test[,-which(colnames(test)%in% c("time","status"))]
  te_predictormatrix=data.matrix(te_predictormatrix)
  coxboost=CoxBoost::CoxBoost(time=train$time,status=train$status,x=tr_predictormatrix,stepno=10,penalty=100)
  
  lpnew <- -predict(coxboost,type="risk",times=median(test$time),newdata=te_predictormatrix)
  lp <- -predict(coxboost,type="risk",times=median(train$time),newdata=tr_predictormatrix)
  
  data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")

  predicted <- list(
    lp,
    lpnew
  )
  
  trioB1$data <- data
  
  evaluation <- trioB1$evaluate(list(surv_obj = predicted))
  
  trioB1$data <- data[ , -which(names(data) %in% c("index"))]
  
  cv_res_harrelCIndex[i] = evaluation$surv_obj$`Harrel C-Index`
  cv_res_brierScore[i] = evaluation$surv_obj$`Brier Score`
  cv_res_timeDependentAUC[i] = evaluation$surv_obj$AUC
  
}

```

Visualization

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
cindex_results <- data.frame(cindex_values = cv_res)

th <-   theme(text=element_text(size=12 ),
              axis.text.x = element_text(angle = 45, hjust = 1),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_rect(colour = "black", size=0.2, fill=NA) )

ggplot(cindex_results, aes(y = cindex_values)) +
  geom_boxplot() +
  labs(y = "C-Index") +
  theme_minimal() +
  th
```


# trioA

```{r, message=FALSE}
library(clusterProfiler)
library(DOSE)
library(DO.db)
library(EnsDb.Hsapiens.v86)
```

```{r}
get_DO_data <- function(ont="DO") {
  ont="DO"
  if (ont == "DO"){
      tryCatch(utils::data(list="DO2ALLEG", package="DOSE"))
      assign("DO2ALLEG", DO2ALLEG )
      DO2ALLEG <- get("DO2ALLEG")

      tryCatch(utils::data(list="EG2ALLDO", package="DOSE"))
      assign("EG2ALLDO", EG2ALLDO )
      EG2ALLDO <- get("EG2ALLDO")
    
    PATHID2EXTID <- get("DO2ALLEG" )
    EXTID2PATHID <- get("EG2ALLDO" )
    
    PATH2NAME.df <- toTable(DOTERM)
    PATH2NAME.df <- PATH2NAME.df[, c("do_id", "Term")]
    PATH2NAME.df <- unique(PATH2NAME.df)
    PATH2NAME <- PATH2NAME.df[,2]
    names(PATH2NAME) <- PATH2NAME.df[,1]
 
  }else if (ont == "DOLite"){
    
      tryCatch(utils::data(list="DOLite2EG", package="DOSE"))
      assign("DOLite2EG", DOLite2EG ) 
      DOLite2EG <- get("DOLite2EG")
      
      tryCatch(utils::data(list="EG2DOLite", package="DOSE"))
      assign("EG2DOLite", EG2DOLite )
      EG2DOLite <- get("EG2DOLite")
      
      tryCatch(utils::data(list="DOLiteTerm", package="DOSE"))
      assign("DOLiteTerm", DOLiteTerm )
      DOLiteTerm <- get("DOLiteTerm")
    
    PATHID2EXTID <- get("DOLite2EG")
    EXTID2PATHID <- get("EG2DOLite")
    PATH2NAME <- get("DOLiteTerm")
  }
   
  return( list(PATHID2EXTID = PATHID2EXTID , 
               PATH2NAME  = PATH2NAME 
               ) )
}

get_DO_pathway <- function(ont = "DO", patterns = c("diabetes", "cardiovascular", "heart", "cardiac", "hypertension")) {
  
  database <- get_DO_data(ont = ont)
  DOpathway <- database$PATHID2EXTID
  pathway_name <- database$PATH2NAME
  
  selected_pathway <- pathway_name[grep(paste0(patterns, collapse = "|"), pathway_name)]
  selected_pathway <- selected_pathway[!selected_pathway %in% c("carcinoma", "tumor", "cancer", "defect")]
  
  DOpathway <- DOpathway[names(DOpathway) %in% names(selected_pathway)]
  selected_pathway <- selected_pathway[match(names(DOpathway), names(selected_pathway))]
  names(DOpathway) <- unname(selected_pathway)
  
  DOpathway <- DOpathway[sapply(DOpathway, length) >= 10]
  
  for (i in seq_along(DOpathway)) {
    this <- DOpathway[i]
    getgene <- ensembldb::select(EnsDb.Hsapiens.v86,
                                 keys = unname(this)[[1]],
                                 keytype = "ENTREZID",
                                 columns = c("SYMBOL", "ENTREZID"))
    DOpathway[[i]] <- unique(getgene$SYMBOL)
  }
  
  return(DOpathway)
}

```

```{r, message=FALSE}
testCache <- tempdir()
trioA <- Trio$new("figshare:26142922/47361079", cachePath = testCache)
data <- trioA |> purrr::pluck("data")
data_log_normalized <- data %>%
  mutate(across(where(is.numeric), ~ log(. + 1)))
data <- data_log_normalized
```

```{r}
calculate_scores <- function(to_eval, gs) {
  colnames_data <- colnames(to_eval)
  scores <- sapply(names(gs), function(pathway) {
    genes <- intersect(gs[[pathway]], colnames_data)
    gene_means <- sapply(genes, function(gene) mean(to_eval[[gene]], na.rm = TRUE))
    sum(gene_means, na.rm = TRUE)
  })
  return(scores)
}

```

```{r}
trioA$addMetric("disease score", calculate_scores)
trioA$addAuxData("get_DO_pathway", get_DO_pathway, c("disease score"))
trioA$data <- data
# result <- calculate_scores(data, DOpathway)

evaluation <- trioA$evaluate(list(get_DO_pathway = data))
disease_scores <- evaluation$get_DO_pathway$`disease score`


df <- data.frame(
  Disease = names(disease_scores),
  Normalized_Score = disease_scores
)


ggplot(df, aes(x = reorder(Disease, Normalized_Score), y = Normalized_Score)) +
  geom_bar(stat = "identity", fill = "#E64525") +
  coord_flip() +  # Flip coordinates for better readability
  labs(x = "Disease", y = "Score") +
  th
```



