---
title: "TrioR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TrioR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, message=FALSE}
devtools::load_all()
library(TrioR)
```

# Import data

- Here, we use the survival data from survBenchmark-figShare. 
- This survival data is clinical (lung). 
- The Figshare ID is [26142922/47361046](https://figshare.com/articles/dataset/SurvBenchmark_comprehensive_benchmarking_study_of_survival_analysis_methods_using_both_omics_data_and_clinical_data/26142922?file=47361046) 


```{r}
testCache <- system.file("extdata", "testdata", package = "TrioR")
trio <- Trio$new("figshare:26142922/47361046", cachePath = testCache)
data <- trio |> purrr::pluck("data", 1)

dplyr::glimpse(data)
```

# Prepare survival model 

In this example, we use Cox proportional hazards regression model. 
Since we use c-index as evaluation metric, we here use one of the Cross-validation folds for an example. 

```{r}
cvSets <- cvTools::cvFolds(n = nrow(data), K = 3, R = 1)
j <- 1
test_id <- cvSets$subsets[cvSets$which == j]
test <- data[test_id, ]
train <- data[-test_id, ]
fit <- survival::coxph(survival::Surv(time, status) ~ age + sex + ph.ecog + pat.karno + meal.cal + wt.loss, data = train)
# data$index <- ifelse(1:nrow(data) %in% test_id, "test", "train")
# all_surv_obj <- with(data, survival::Surv(time, status))
fit
```

# Preapre function

- surv_risk_pred: risk prediction/expectation
- surv_obj: survival object, this is for Gold Standard
- harrelCIndexMetric: evaluation metric, we use harrel c-index

```{r}
surv_risk_pred <- function(model, data) {
  if (is.null(data)) {
    stats::predict(model, type = "risk")
  } else {
    stats::predict(model, newdata = data, type = "risk")
  }
}

surv_obj <- function(data) {
  all_surv_obj <- with(data, survival::Surv(time, status))
  # test_index <- which(data$index == "test")
  # train_index <- which(data$index == "train")
  return(all_surv_obj)
}


harrelCIndexMetric <- function(gs, to_eval) {
  harrelC1 <- Hmisc::rcorr.cens(-to_eval[[2]], gs[[2]])
  return(harrelC1["C Index"])
}

```

# TrioR demo

```{r}
# create expectation eg. risk in prediction, here is the list
expected <- list(surv_risk_pred(fit,NULL),surv_risk_pred(fit,test))

trio$addGS("surv_obj", surv_obj, c("Harrel C-Index"))

# actual, same as expectation
actual <- list(trio$getGS("surv_obj") |> purrr::pluck(1) |> (\(x) x[-test_id])(), trio$getGS("surv_obj") |> purrr::pluck(1) |> (\(x) x[test_id])())

# actual <- list(all_surv_obj[-test_id, ], all_surv_obj[test_id, ])

#actual <- trio$getGS("surv_obj") |> purrr::pluck(1)

trio$addMetric("Harrel C-Index", harrelCIndexMetric)
# actual <- trio$getGS("surv_obj") |> purrr::pluck(1)

```

```{r}
# bug here, expected and actual are using different function, but currently it only support one function for actual and prediction.
# for example, in spatialsimbench, evaluation is only be one function for fraczero
# evaluation <- trio$evaluate(list(surv_obj = actual)) # error

actual_eval <- harrelCIndexMetric(actual, expected)

# expect_equal(actual_eval, purrr::pluck(evaluation, "surv_obj", "Harrel C-Index")) # error

print(actual_eval)
```

